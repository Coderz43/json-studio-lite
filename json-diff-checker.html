<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON Studio Lite ‚Äî Difference</title>
  <meta name="description" content="Compare two JSON blobs and see differences." />
  <link rel="icon" href="assets/favicon.ico" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="assets/styles.css" />
  <link rel="stylesheet" href="styles/theme.css" />

  <style>
 :root{
  --line-active: #fff4b3;
  --line-diff:  #b7f3de;
  --token-del:  #ffd9d9;
  --token-add:  #c8f5e6;
  --pane-border:#d7dbe3;
  --pane-toolbar:#e6e9ef;
  --pane-bg:#ffffff;

  /* Gradient button colors (light + dark consistent) */
  --btn-gradient: linear-gradient(90deg, #ff7e29, #3a8dff);
  --btn-text: #fff;
}

/* --- Dark mode: match Convert page --- */
html[data-theme="dark"] {
  --pane-border: #1b2030;
  --pane-toolbar: #1e2430;
  --pane-bg: #141927;        /* both pane backgrounds */
  --line-active: #23293a;    /* subtle active line */
  --line-diff: #223a32;      /* greenish line diff */
  --token-del: #3a2628;      /* soft red */
  --token-add: #1f3a31;      /* soft green */
  --btn-gradient: linear-gradient(90deg, #ff7e29, #3a8dff); /* same as convert */
  --btn-text: #fff;
}
.brand .logo-skeleton,
.brand .brand-name { display:none; }

.brand-logo{ height:32px; display:block }
@media (min-width:1024px){ .brand-logo{ height:36px } }


/* Apply inline bg to the Ace editor too */
html[data-theme="dark"] .ace-monokai {
  background-color: #141927 !important;
  color: #e6edf3 !important;
}
html[data-theme="dark"] .ace-monokai .ace_text-layer {
  color: #e6edf3 !important;
}
html[data-theme="dark"] .ace-monokai .ace_gutter {
  background: #141927 !important;
  color: #8b93a6 !important;
  border-right: 1px solid #1b2030 !important;
}
html[data-theme="dark"] .ace-monokai .ace_print-margin {
  background: #141927 !important;
}
html[data-theme="dark"] .ace-monokai .ace_cursor {
  color: #e6edf3 !important;
}
html[data-theme="dark"] .ace-monokai .ace_marker-layer .ace_selection {
  background: #2b3550 !important;
}

.convert-grid{ grid-template-columns:1fr 220px 1fr; gap:16px; }
.convert-center{ display:flex; flex-direction:column; align-items:center; gap:12px; padding-top:8px; }

.pane-toolbar{
  background:var(--pane-toolbar);
  border:1px solid var(--pane-border);
  border-bottom:none; border-radius:12px 12px 0 0;
  padding:8px; display:flex; gap:8px; align-items:center;
}
.toolbar-right{ margin-left:auto; }

.editor-shell{
  border:1px solid var(--pane-border);
  border-top:none; border-radius:0 0 12px 12px;
  overflow:hidden; background:var(--pane-bg);
}
.ace-wrap{ position:relative; height:640px; width:100%; }

/* Ace markers */
.ace_marker-layer .line-diff{ position:absolute; background:var(--line-diff); }
.ace_marker-layer .token-del{ position:absolute; background:var(--token-del); }
.ace_marker-layer .token-add{ position:absolute; background:var(--token-add); }

/* Active line color override */
.ace_editor .ace_marker-layer .ace_active-line{ background: var(--line-active) !important; }

/* Make the ‚ÄúShow Difference‚Äù button gradient like Convert */
.cta-diff{
  display:grid;
  place-items:center;
  width:190px; height:64px;
  border-radius:16px;
  font-weight:800;
  color:var(--btn-text);
  background: var(--btn-gradient);
  box-shadow:var(--shadow);
  border:none;
  cursor:pointer;
  transition:0.2s ease-in-out;
}
.cta-diff:hover{
  opacity:0.9;
}

.status{ font-weight:600; color:var(--muted); text-align:center; }

@media (max-width:980px){
  .convert-grid{ grid-template-columns:1fr; }
  .convert-center{ order:-1; }
  .ace-wrap{ height:440px; }
}

  </style>
</head>
<body>
  <!-- ===== Header (kept) ===== -->
  <header class="topbar">
   <div class="brand">
  <a href="index.html" class="brand-link" aria-label="JSON Studio Lite">
    <img src="assets/icons/jsl-logo.svg" alt="JSON Studio Lite" class="brand-logo">
  </a>
</div>
    <nav class="tabs" aria-label="Primary">
      <a class="tab" href="view/json-format-viewer.html">View</a>
      <a class="tab" href="index.html">Convert</a>
      <a class="tab active" href="json-diff-checker.html" aria-current="page">Difference</a>
      <a class="tab" href="samples.html">Samples</a>
    </nav>
    <div class="actions">
      <button id="themeToggle" class="btn ghost" title="Toggle theme" aria-label="Toggle theme">‚òæ</button>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="convert-grid">
    <!-- Left -->
    <section class="pane">
      <header class="pane-toolbar">
        <label class="btn" for="fileA">
          <input id="fileA" hidden type="file" accept=".json,.txt,application/json" />
          ‚§¥ Upload
        </label>
        <button class="btn" id="downA">‚¨á Download</button>
        <button class="btn ghost" id="copyA">üìã Copy</button>
        <div class="toolbar-right">
          <button class="btn ghost" id="fsA">‚§¢</button>
        </div>
      </header>
      <div class="editor-shell"><div id="edA" class="ace-wrap"></div></div>
    </section>

    <!-- Center -->
    <aside class="convert-center">
      <button id="doDiff" class="btn cta-diff">{ } Show Difference</button>
      <div id="status" class="status">Paste valid JSON in both panes.</div>
      <button id="swap" class="btn">‚áÑ Swap</button>
      <button id="clearBoth" class="btn ghost">‚úñ Clear Both</button>
    </aside>

    <!-- Right -->
    <section class="pane">
      <header class="pane-toolbar">
        <label class="btn" for="fileB">
          <input id="fileB" hidden type="file" accept=".json,.txt,application/json" />
          ‚§¥ Upload
        </label>
        <button class="btn" id="downB">‚¨á Download</button>
        <button class="btn ghost" id="copyB">üìã Copy</button>
        <div class="toolbar-right">
          <button class="btn ghost" id="fsB">‚§¢</button>
        </div>
      </header>
      <div class="editor-shell"><div id="edB" class="ace-wrap"></div></div>
    </section>
  </main>

  <!-- ===== Feedback (kept) ===== -->
  <section class="feedback-section" id="feedback">
    <h2>üí¨ We value your Feedback</h2>
    <form id="feedbackForm" class="feedback-form">
      <div class="field">
        <input type="text" id="fbName" required>
        <label for="fbName">Your Name</label>
      </div>
      <div class="field">
        <input type="email" id="fbEmail" required>
        <label for="fbEmail">Your Email</label>
      </div>
      <div class="field">
        <textarea id="fbMessage" rows="4" required></textarea>
        <label for="fbMessage">Your Message</label>
      </div>
      <button type="submit" class="btn gradient">Submit Feedback</button>
    </form>
  </section>

  <!-- ===== Footer (kept) ===== -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-left">
        <h3>‚ö° JSON Studio Lite</h3>
        <p>Simple, fast, offline-ready JSON tools. Built with ‚ù§Ô∏è for developers.</p>
      </div>
      <div class="footer-center">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="view/json-format-viewer.html">View</a></li>
          <li><a href="index.html">Convert</a></li>
          <li><a href="json-diff-checker.html">Difference</a></li>
          <li><a href="samples.html">Samples</a></li>
        </ul>
      </div>
      <div class="footer-right">
        <h4>Connect</h4>
        <div class="social">
          <a aria-label="Twitter" href="#"><img src="assets/icons/twitter.svg" alt="Twitter"></a>
          <a aria-label="LinkedIn" href="#"><img src="assets/icons/linkedin.svg" alt="LinkedIn"></a>
          <a aria-label="GitHub" href="#"><img src="assets/icons/github.svg" alt="GitHub"></a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>¬© <span id="year"></span> JSON Studio Lite.</p>
    </div>
  </footer>

  <!-- ===== Ace Editor (light + dark themes) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.9/src-min-noconflict/ace.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.9/src-min-noconflict/ext-language_tools.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.9/src-min-noconflict/mode-json.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.9/src-min-noconflict/theme-textmate.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.9/src-min-noconflict/theme-monokai.js"></script>

  <script>
    // Footer year
    const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear();

    // ----- Ace setup (gutter numbers + active yellow line) -----
    const Range = ace.require('ace/range').Range;
    function mkEditor(id, theme){
      const ed = ace.edit(id);
      ed.session.setMode("ace/mode/json");
      ed.setTheme(theme);
      ed.setOptions({
        showGutter: true,
        highlightActiveLine: true,
        showPrintMargin: true,
        printMargin: 100,
        fontSize: "14px",
        tabSize: 2,
        useSoftTabs: true,
        wrap: false
      });
      return ed;
    }

    // Choose theme based on current data-theme
    function currentAceTheme(){
      return document.documentElement.getAttribute('data-theme') === 'dark'
        ? "ace/theme/monokai"
        : "ace/theme/textmate";
    }

    const edA = mkEditor('edA', currentAceTheme());
    const edB = mkEditor('edB', currentAceTheme());
    const statusEl = document.getElementById('status');

    // Toggle theme -> also switch Ace theme + pane colors handled by CSS vars
    document.getElementById('themeToggle')?.addEventListener('click', () => {
      const root = document.documentElement;
      const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', next);
      const theme = currentAceTheme();
      edA.setTheme(theme);
      edB.setTheme(theme);
    });

    function pretty(obj){ return JSON.stringify(obj, null, 2); }
    function safeParse(s){ try{ return JSON.parse(s); }catch{ return null; } }

    function clearMarks(ed){
      ed.session.getMarkers(true);
      const markers = ed.session.getMarkers(true) || {};
      Object.keys(markers).forEach(id => ed.session.removeMarker(id));
      ed.session.clearAnnotations();
    }
    function markFullLine(ed, line, klass){
      return ed.session.addMarker(new Range(line,0,line,1), klass, 'fullLine');
    }
    function markSpan(ed, line, fromCh, toCh, klass){
      return ed.session.addMarker(new Range(line,fromCh,line,Math.max(fromCh+1,toCh)), klass, 'text');
    }

    // Simple LCS for within-line highlighting
    function lcsKeepIdx(a, b){
      const m=a.length,n=b.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=1;i<=m;i++) for(let j=1;j<=n;j++)
        dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1]);
      let i=m,j=n,keep=new Set();
      while(i>0&&j>0){
        if(a[i-1]===b[j-1]){ keep.add(i-1); i--; j--; }
        else if(dp[i-1][j]>=dp[i][j-1]) i--; else j--;
      }
      return keep;
    }

    function tokenDiff(ed, lineIdx, left, right, invert=false){
      if(left===right) return;
      const keep = lcsKeepIdx(left, right);
      let i=0;
      while(i<left.length){
        if(keep.has(i)){ i++; continue; }
        let j=i;
        while(j<left.length && !keep.has(j)) j++;
        markSpan(ed, lineIdx, i, j, invert ? 'token-add' : 'token-del');
        i=j;
      }
    }

    function runDiff(){
      const aObj = safeParse(edA.getValue().trim());
      const bObj = safeParse(edB.getValue().trim());
      if(!aObj||!bObj){ statusEl.textContent = "‚ùó Paste valid JSON in both panes."; return; }

      // pretty print for stable line layout
      edA.setValue(pretty(aObj), -1);
      edB.setValue(pretty(bObj), -1);

      clearMarks(edA); clearMarks(edB);

      const A = edA.getValue().split('\n');
      const B = edB.getValue().split('\n');
      const max = Math.max(A.length,B.length);
      let count = 0;
      for(let i=0;i<max;i++){
        const L=A[i]??"", R=B[i]??"";
        if(L!==R){
          count++;
          markFullLine(edA, i, 'line-diff'); markFullLine(edB, i, 'line-diff');
          tokenDiff(edA, i, L, R, false);
          tokenDiff(edB, i, R, L, true);
        }
      }
      statusEl.textContent = count ? `${count} line(s) differ.` : "No differences.";
    }

    document.getElementById('doDiff').addEventListener('click', runDiff);

    // Upload / Download / Copy / Fullscreen / Swap / Clear
    function readFileInto(input, ed){
      const f=input.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=> ed.setValue(String(r.result||""), -1); r.readAsText(f);
    }
    document.getElementById('fileA')?.addEventListener('change', e=>readFileInto(e.target, edA));
    document.getElementById('fileB')?.addEventListener('change', e=>readFileInto(e.target, edB));

    function download(text, name){
      const blob=new Blob([text||""],{type:"application/json"});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
      URL.revokeObjectURL(a.href);
    }
    document.getElementById('downA').onclick = ()=>download(edA.getValue(),'left.json');
    document.getElementById('downB').onclick = ()=>download(edB.getValue(),'right.json');

    document.getElementById('copyA').onclick = ()=>navigator.clipboard.writeText(edA.getValue()||"");
    document.getElementById('copyB').onclick = ()=>navigator.clipboard.writeText(edB.getValue()||"");

    document.getElementById('fsA').onclick = ()=>document.getElementById('edA').requestFullscreen?.();
    document.getElementById('fsB').onclick = ()=>document.getElementById('edB').requestFullscreen?.();

    document.getElementById('swap').onclick = ()=>{
      const t=edA.getValue(); edA.setValue(edB.getValue(),-1); edB.setValue(t,-1);
      clearMarks(edA); clearMarks(edB); statusEl.textContent="Ready. Click ‚ÄúShow Difference‚Äù.";
    };
    document.getElementById('clearBoth').onclick = ()=>{
      edA.setValue("",-1); edB.setValue("",-1);
      clearMarks(edA); clearMarks(edB); statusEl.textContent="Paste valid JSON in both panes.";
    };

    // Ctrl/Cmd+Enter = run diff
    document.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter') runDiff();
    });
  </script>
</body>
</html>
